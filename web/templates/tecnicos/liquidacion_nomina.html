{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - Huellero CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supervision.css' %}">
{% endblock %}

{% block container_class %}container-fluid{% endblock %}

{% block content %}
<!-- Navegaci贸n de usuario -->
<nav class="user-nav">
    <div class="user-nav__info">
        <span></span>
        <span class="user-nav__name">{{ user.get_full_name|default:user.username }}</span>
        <span class="user-nav__area">(Supervisi贸n)</span>
    </div>
    <div>
        <a href="{% url 'supervision:index' %}" class="user-nav__link"> Inicio</a>
        <a href="{% url 'users:logout' %}" class="user-nav__link"> Cerrar Sesi贸n</a>
    </div>
</nav>

<header class="header">
    <div class="header__icon"></div>
    <h1 class="header__title">{{ titulo }}</h1>
    <p class="header__subtitle">Corporaci贸n Hacia un Valle Solidario</p>
</header>

<section class="content-section">
    <!-- Filtros -->
    <div class="filters-card">
        <form method="get" class="filters-form">
            <div class="form-group">
                <label for="supervisor" class="form-label">Supervisor</label>
                <input type="text" name="supervisor" id="supervisor" class="form-input" 
                       placeholder="Buscar por supervisor..." value="{{ filtros.supervisor }}">
            </div>

            <div class="form-group">
                <label for="sede" class="form-label">Sede / Centro</label>
                <input type="text" name="sede" id="sede" class="form-input" 
                       placeholder="Buscar por sede..." value="{{ filtros.sede }}">
            </div>

            <div class="form-group">
                <label for="mes" class="form-label">Mes</label>
                <select name="mes" id="mes" class="form-select">
                    <option value="">Todos los meses</option>
                    {% for m_val, m_nom in meses %}
                        <option value="{{ m_val }}" {% if filtros.mes == m_val %}selected{% endif %}>
                            {{ m_nom }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn--filter">
                     Filtrar
                </button>
                <a href="?" class="btn btn--clear">
                    Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Barra de acciones -->
    <div class="actions-bar">
        <a href="?" class="btn btn--secondary">
             Actualizar Datos
        </a>
    </div>

    {% if error_message %}
    <div class="alert alert--warning">
        <span class="alert__icon">锔</span>
        <span><strong>Atenci贸n:</strong> {{ error_message }}</span>
    </div>
    {% endif %}

    <!-- Estad铆sticas -->
    <div class="stats-grid">
        <div class="stat-card stat-card--info">
            <div class="stat-card__header">
                <span class="stat-card__icon"></span>
                D铆as N贸mina
            </div>
            <div class="stat-card__value">{{ stats.dias_nomina }}</div>
            <div class="stat-card__desc">Con horas reportadas</div>
        </div>
        <div class="stat-card stat-card--success">
            <div class="stat-card__header">
                <span class="stat-card__icon"></span>
                D铆as Raciones
            </div>
            <div class="stat-card__value">{{ stats.dias_raciones }}</div>
            <div class="stat-card__desc">Con producci贸n reportada</div>
        </div>
        <div class="stat-card stat-card--danger">
            <div class="stat-card__header">
                <span class="stat-card__icon">锔</span>
                Inconsistencias
            </div>
            <div class="stat-card__value">{{ stats.inconsistencias }}</div>
            <div class="stat-card__desc">Cruce Horas vs Raciones</div>
        </div>
    </div>

    <!-- Novedades de hojas relacionadas -->
    <div class="stats-grid stats-grid--novedades">
        <div class="stat-card stat-card--warning">
            <div class="stat-card__header">
                <span class="stat-card__icon"></span>
                Novedades N贸mina Cali
            </div>
            <div class="stat-card__value">{{ novedades_nomina.cantidad }}</div>
            <div class="stat-card__desc">
                {% if novedades_nomina.fechas %}
                    {{ novedades_nomina.fechas|length }} d铆a{{ novedades_nomina.fechas|length|pluralize:"s" }} con novedad
                {% else %}
                    Sin novedades registradas
                {% endif %}
            </div>
            {% if novedades_nomina.fechas %}
            <div class="stat-card__dates">
                {% for fecha in novedades_nomina.fechas|slice:":5" %}
                    <span class="date-chip">{{ fecha }}</span>
                {% endfor %}
                {% if novedades_nomina.fechas|length > 5 %}
                    <span class="date-chip date-chip--more">+{{ novedades_nomina.fechas|length|add:"-5" }} m谩s</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="stat-card stat-card--warning">
            <div class="stat-card__header">
                <span class="stat-card__icon"></span>
                Novedades Facturaci贸n
            </div>
            <div class="stat-card__value">{{ novedades_facturacion.cantidad }}</div>
            <div class="stat-card__desc">
                {% if novedades_facturacion.fechas %}
                    {{ novedades_facturacion.fechas|length }} d铆a{{ novedades_facturacion.fechas|length|pluralize:"s" }} con novedad
                {% else %}
                    Sin novedades registradas
                {% endif %}
            </div>
            {% if novedades_facturacion.fechas %}
            <div class="stat-card__dates">
                {% for fecha in novedades_facturacion.fechas|slice:":5" %}
                    <span class="date-chip">{{ fecha }}</span>
                {% endfor %}
                {% if novedades_facturacion.fechas|length > 5 %}
                    <span class="date-chip date-chip--more">+{{ novedades_facturacion.fechas|length|add:"-5" }} m谩s</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <h2 class="card__title">
            <span class="card__title-icon"></span>
            Detalle de Registros
        </h2>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        {% for header in headers %}
                            <th>{{ header }}</th>
                        {% empty %}
                            <th>Sin datos</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr class="{% if row.alert %}row-alert{% endif %}" title="{{ row.alert_msg }}">
                            {% for cell in row.cells %}
                                <td>
                                    {% if forloop.first and row.alert %}
                                        <span class="text-danger mr-1">锔</span>
                                    {% endif %}
                                    {{ cell }}
                                </td>
                            {% endfor %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="{{ headers|length|default:'1' }}" class="text-center">
                                No se encontraron registros que coincidan con los filtros.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-info">
            <span>Registros visualizados: <strong>{{ rows|length }}</strong></span>
        </div>
    </div>
</section>
{% endblock %}
