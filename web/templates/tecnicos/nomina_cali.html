{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} - Huellero CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supervision.css' %}">
{% endblock %}

{% block container_class %}container-fluid{% endblock %}

{% block content %}
<!-- NavegaciÃ³n de usuario -->
<nav class="user-nav">
    <div class="user-nav__info">
        <span>ğŸ‘¤</span>
        <span class="user-nav__name">{{ user.get_full_name|default:user.username }}</span>
        <span class="user-nav__area">(SupervisiÃ³n)</span>
    </div>
    <div>
        <a href="{% url 'supervision:index' %}" class="user-nav__link">ğŸ  Inicio</a>
        <a href="{% url 'users:logout' %}" class="user-nav__link">ğŸšª Cerrar SesiÃ³n</a>
    </div>
</nav>

<header class="header">
    <div class="header__icon">ğŸŒ´</div>
    <h1 class="header__title">{{ titulo }}</h1>
    <p class="header__subtitle">CorporaciÃ³n Hacia un Valle Solidario</p>
</header>

<section class="content-section">
    <!-- Filtros -->
    <div class="filters-card">
        <form method="get" class="filters-compact" id="filtrosForm">
            <div class="form-group">
                <label for="ubicacion" class="form-label">UbicaciÃ³n</label>
                <select name="ubicacion" id="ubicacion" class="form-select" onchange="this.form.submit()">
                    <option value="CALI" {% if filtros.ubicacion == 'CALI' %}selected{% endif %}>Cali</option>
                    <option value="YUMBO" {% if filtros.ubicacion == 'YUMBO' %}selected{% endif %}>Yumbo</option>
                </select>
            </div>

            <div class="form-group">
                <label for="mes" class="form-label">Mes</label>
                <select name="mes" id="mes" class="form-select" onchange="this.form.submit()">
                    {% for m_val, m_nom in meses %}
                        <option value="{{ m_val }}" {% if filtros.mes == m_val %}selected{% endif %}>
                            {{ m_nom }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="supervisor" class="form-label">Supervisor</label>
                <input type="text" name="supervisor" id="supervisor" class="form-input"
                       placeholder="Buscar..." value="{{ filtros.supervisor }}">
            </div>

            <div class="form-group">
                <label for="sede" class="form-label">Sede</label>
                <input type="text" name="sede" id="sede" class="form-input"
                       placeholder="Buscar..." value="{{ filtros.sede }}">
            </div>

            <!-- DÃ­as seleccionados (ocultos, manejados por JS) -->
            <div id="diasSeleccionadosContainer">
                {% for dia in filtros.dias %}
                    <input type="hidden" name="dias" value="{{ dia }}">
                {% endfor %}
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn--filter">
                    ğŸ” Filtrar
                </button>
                <a href="?mes={{ filtros.mes }}" class="btn btn--clear">
                    Limpiar
                </a>
            </div>
        </form>
    </div>

    {% if error_message %}
    <div class="alert alert--warning">
        <span class="alert__icon">âš ï¸</span>
        <span><strong>AtenciÃ³n:</strong> {{ error_message }}</span>
    </div>
    {% endif %}

    <!-- Grid de 3 columnas -->
    <div class="nomina-grid">
        <!-- Columna Izquierda: Novedades nomina_cali -->
        <div class="novedades-column">
            <div class="novedades-column__header">
                <span>ğŸ“‹</span>
                <h3 class="novedades-column__title">NÃ³mina al dia</h3>
                <span class="novedades-column__count">{{ novedades_nomina|length }}</span>
            </div>

            {% if novedades_nomina %}
                {% for nov in novedades_nomina %}
                <div class="novedad-card" data-nombre="{{ nov.nombre }}">
                    {% if nov.horario_sede %}
                        <div class="novedad-card__horario-top" title="Horario Sede">ğŸ« {{ nov.horario_sede }}</div>
                    {% endif %}
                    <div class="novedad-card__nombre">{{ nov.nombre }}</div>
                    <div class="novedad-card__sede">ğŸ“ {{ nov.descripcion_proyecto }}</div>
                    <div class="novedad-card__detalle">
                        <span class="novedad-card__badge novedad-card__badge--tipo">{{ nov.tipo_tiempo }}</span>
                        <span class="novedad-card__badge novedad-card__badge--dias">ğŸ“† {{ nov.cantidad_dias }} dÃ­a{{ nov.cantidad_dias|pluralize:"s" }}</span>
                        <span class="novedad-card__horas {% if nov.horas_totales == 0 %}novedad-card__horas--zero{% endif %}">â±ï¸ {{ nov.horas_totales|floatformat:1 }}h</span>
                    </div>
                    {% if nov.hora_inicial or nov.hora_final %}
                        <div class="novedad-card__horario">ğŸ• {{ nov.hora_inicial|default:"-" }} - {{ nov.hora_final|default:"-" }}</div>
                    {% endif %}
                    <div class="novedad-card__fechas">ğŸ“… {{ nov.fecha }}</div>
                    {% if nov.observaciones %}
                        <div class="novedad-card__obs">ğŸ’¬ {{ nov.observaciones|truncatewords:10 }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="novedades-empty">
                    <div class="novedades-empty__icon">ğŸ“­</div>
                    <div class="novedades-empty__text">No hay novedades para este perÃ­odo</div>
                </div>
            {% endif %}
        </div>

        <!-- Columna Central: Calendario -->
        <div class="calendario-column">
            <div class="calendario-header">
                <span class="calendario-header__mes">{{ calendario.mes_nombre }} {{ calendario.aÃ±o }}</span>
            </div>

            <table class="calendario-table">
                <thead>
                    <tr>
                        {% for dia_sem in calendario.dias_semana %}
                            <th>{{ dia_sem }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for semana in calendario.semanas %}
                    <tr>
                        {% for dia in semana %}
                        <td>
                            {% if dia == 0 %}
                                <div class="calendario-dia calendario-dia--vacio"></div>
                            {% else %}
                                <div class="calendario-dia
                                    {% if dia in dias_con_novedades and dia in dias_con_nomina %}
                                        calendario-dia--mixto
                                    {% elif dia in dias_con_nomina %}
                                        calendario-dia--nomina
                                    {% elif dia in dias_con_novedades %}
                                        calendario-dia--novedad
                                    {% endif %}
                                    {% if dia|stringformat:'s' in filtros.dias %}calendario-dia--seleccionado{% endif %}"
                                    data-dia="{{ dia }}"
                                    onclick="toggleDia({{ dia }})">
                                    {{ dia }}
                                    {% if dia in dias_con_facturacion %}
                                        <span class="calendario-dia__facturacion">ğŸ½ï¸</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="calendario-leyenda">
                <div class="calendario-leyenda__item">
                    <span class="leyenda-color leyenda-color--nomina"></span>
                    <span>NÃ³mina OK ({{ dias_solo_nomina|length }})</span>
                </div>
                <div class="calendario-leyenda__item">
                    <span class="leyenda-color leyenda-color--novedad"></span>
                    <span>Solo Novedad ({{ dias_solo_novedad|length }})</span>
                </div>
                <div class="calendario-leyenda__item">
                    <span class="leyenda-color leyenda-color--mixto"></span>
                    <span>NÃ³mina + Novedad ({{ dias_mixtos|length }})</span>
                </div>
                <div class="calendario-leyenda__item">
                    <span class="leyenda-color leyenda-color--seleccionado"></span>
                    <span>Seleccionado</span>
                </div>
                <div class="calendario-leyenda__item">
                    <span>ğŸ½ï¸</span>
                    <span>Facturado ({{ dias_con_facturacion|length }})</span>
                </div>
            </div>

            <div class="calendario-acciones">
                <button type="button" class="btn btn--ver-todos" onclick="verTodos()">
                    ğŸ‘ï¸ Ver Todos
                </button>
            </div>
        </div>

        <!-- Columna Derecha: Novedades novedades_cali -->
        <div class="novedades-column">
            <div class="novedades-column__header">
                <span>ğŸ“</span>
                <h3 class="novedades-column__title">Novedades Cali</h3>
                <span class="novedades-column__count">{{ novedades_cali|length }}</span>
            </div>

            {% if novedades_cali %}
                {% for nov in novedades_cali %}
                <div class="novedad-card novedad-card--appsheet" data-nombre="{{ nov.nombre }}">
                    {% if nov.horario_sede %}
                        <div class="novedad-card__horario-top" title="Horario Sede">ğŸ« {{ nov.horario_sede }}</div>
                    {% endif %}
                    <div class="novedad-card__nombre">{{ nov.nombre }}</div>
                    <div class="novedad-card__sede">ğŸ“ {{ nov.sede }}</div>
                    <div class="novedad-card__detalle">
                        {% if nov.tipo_tiempo %}
                            <span class="novedad-card__badge novedad-card__badge--tipo">{{ nov.tipo_tiempo }}</span>
                        {% endif %}
                        <span class="novedad-card__horas js-calc-horas"
                              data-hora-ini="{{ nov.hora_inicial }}"
                              data-hora-fin="{{ nov.hora_final }}"
                              data-skip-tipo="true">â±ï¸ --h</span>
                    </div>
                    {% if nov.hora_inicial or nov.hora_final %}
                        <div class="novedad-card__horario">ğŸ• {{ nov.hora_inicial|default:"-" }} - {{ nov.hora_final|default:"-" }}</div>
                    {% endif %}
                    <div class="novedad-card__fechas">ğŸ“… {{ nov.rango_fechas }}</div>
                    {% if nov.observaciones %}
                        <div class="novedad-card__obs">ğŸ’¬ {{ nov.observaciones|truncatewords:10 }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="novedades-empty">
                    <div class="novedades-empty__icon">ğŸ“­</div>
                    <div class="novedades-empty__text">No hay novedades para este perÃ­odo</div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- SecciÃ³n Detalle Manipuladora (Oculta inicialmente) -->
    <div id="detalleManipuladora" class="detalle-section" style="display: none;">
        <div class="detalle-header">
            <div class="detalle-info">
                <h3 id="detalleSedeTitle">Sede: ...</h3>
                <span id="detalleCount" class="detalle-sede">0 Colaboradores</span>
            </div>
            <button class="btn-close-detalle" onclick="cerrarDetalle()">âœ–</button>
        </div>
        
        <div id="detalleTeamList" class="team-list">
            <!-- Se llena dinÃ¡micamente con JS -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Pasar datos al JS de forma segura -->
{{ asistencia_data|json_script:"asistencia-data" }}
<script src="{% static 'js/nomina_cali.js' %}"></script>
{% endblock %}
